\documentclass[twoside, final, 10pt]{articleMine}
\usepackage[english]{babel}
\usepackage[sc]{mathpazo}
\usepackage{a4wide}
\usepackage{subfigure}

\usepackage{hyperref}
\usepackage{amsmath,amssymb}
\usepackage[right]{lineno}
\usepackage{xspace}
\usepackage{accents}
\usepackage{graphicx}
\usepackage{booktabs}
\usepackage{color}
\usepackage{units}
\usepackage{enumitem}
\usepackage{todonotes}
\usepackage[capitalize]{cleveref}
\usepackage{nameref}
\usepackage{csquotes}

\usepackage{listings}
\usepackage{color}

\definecolor{dkgreen}{rgb}{0,0.6,0}
\definecolor{gray}{rgb}{0.5,0.5,0.5}
\definecolor{mauve}{rgb}{0.58,0,0.82}

\lstset{frame=tb,
  language=XML,
  aboveskip=3mm,
  belowskip=3mm,
  showstringspaces=false,
  columns=flexible,
  basicstyle={\small\ttfamily},
  numbers=none,
  numberstyle=\tiny\color{gray},
  keywordstyle=\color{blue},
  commentstyle=\color{dkgreen},
  stringstyle=\color{mauve},
  breaklines=true,
  breakatwhitespace=true,
  tabsize=3
}

\usepackage[thinc]{esdiff}


\usepackage{booktabs}
\usepackage{mcite}


\graphicspath{{plots/}}
\newcommand*\patchAmsMathEnvironmentForLineno[1]{%
  \expandafter\let\csname old#1\expandafter\endcsname\csname #1\endcsname
  \expandafter\let\csname oldend#1\expandafter\endcsname\csname end#1\endcsname
  \renewenvironment{#1}%
     {\linenomath\csname old#1\endcsname}%
     {\csname oldend#1\endcsname\endlinenomath}}%
\newcommand*\patchBothAmsMathEnvironmentsForLineno[1]{%
  \patchAmsMathEnvironmentForLineno{#1}%
  \patchAmsMathEnvironmentForLineno{#1*}}%
\AtBeginDocument{%
\patchBothAmsMathEnvironmentsForLineno{equation}%
\patchBothAmsMathEnvironmentsForLineno{align}%
\patchBothAmsMathEnvironmentsForLineno{flalign}%
\patchBothAmsMathEnvironmentsForLineno{alignat}%
\patchBothAmsMathEnvironmentsForLineno{gather}%
\patchBothAmsMathEnvironmentsForLineno{multline}%
}

\newcommand{\putat}[3]{\begin{picture}(0,0)(0,0)\put(#1,#2){#3}\end{picture}} % just a shorthand
\parskip 4.2pt           % sets spacing between paragraphs
%\parindend 0pt           % sets spacing between paragraphs
\def\Offline{\mbox{$\overline{\rm
Off}$\hspace{.05em}\raisebox{.4ex}{$\underline{\rm line}$}}\xspace}
\def\OfflineB{\mbox{$\bf\overline{\rm\bf
Off}$\hspace{.05em}\raisebox{.4ex}{$\bf\underline{\rm\bf line}$}}\xspace}

\newcommand{\qpkDist}{$Q^\mathrm{Pk}_\mathrm{Dist}$\,}
\newcommand{\qpkNormDist}{$Q^\mathrm{Pk}_\mathrm{NormDist}$\,}

\include{myabbr}


\begin{document}
\setpagewiselinenumbers
\modulolinenumbers[2]

\linenumbers

\renewcommand\linenumberfont{\small\rmfamily}
\begin{flushright}
%GAP-2021-xx
\end{flushright}

\begin{flushright}
  \rule{\linewidth}{0.5mm}
  \\[17mm]
  \vspace*{-3ex}{\Large Accuracy of $Q^\mathrm{Peak}_\mathrm{VEM}$ fit for UB and UUB}
  \large
  \parbox[b]{15cm}
  {
    \begin{flushright}
      Mauricio Su\'arez-Dur\'an and  Ioana~C.~Mari\c{s}
      \\[6mm]
      {\small Universit{\'e} Libre de Bruxelles, Belgium}
    \end{flushright}
  }
  \\[5mm]
  \rule{\linewidth}{0.5mm}
\end{flushright}
%
%\vspace*{-5ex}
%
\thispagestyle{empty}
\noindent

\begin{abstract}
  \noindent
  From the installation of the Upgraded Unified Board (UUB) is
  expected to have a better accuracy for the estimation of the
  \qpkvem values respect of the previous Unified Board (UB).
  Here, the process to calculate the accuracy of the \qpkvem
  values for the UUB and UB is presented, and the results for
  $75$ UUB stations, and their respective UB version, are showed.
\end{abstract}


\thispagestyle{empty}
$\;$
%\listoftodos
%\newpage
\noindent
\clearpage

\section{Introduction}
The deployment of the Upgraded Unified Board (UUB) of the WCDs of
belonging to the surface array\,\cite{augerPrimeDesign} requires
a systematic calibration, taken as reference the previous Unified
Board (UB). A quantity that works as checker of this calibration
stability is the \qpkvem and its accuracy, which it is important
also to understand the fluctuation of the signals recorded by the
WCDs\,\cite{gap2003-030}. This quantity is extracted from fitting
the muon hump presented in the charge calibration
histograms.\\\\In order to calculate the accuracy of the \qpkvem,
here we have implemented a method to fit and extract the
respective \qpkvem, for both UUB and UB. Then, the accuracy was
calculated for a set of values into a time window of seven days.
This time period was chosen by following the implementation of a
sliding widow algorithm, through which the stablest \qpkvem
average per day in seven days was found.

\section{Fitting histograms}
\label{secFitting}

\begin{figure}[!t]
  \label{figChargeDerivative}
  \centering
  \subfigure {
    \includegraphics[width=.5\textwidth]{../../plots/chargeHisto863.pdf}
    \includegraphics[width=.5\textwidth]{../../plots/chargeDerHisto863.pdf}
  }
  \caption{Fitting algorithm to fit the muon hump in calibration
  charge histogram (see details in the text). Left: a sample of a
  typical charge calibration histogram, where the black line
  represents the smoothing histogram ($H_S$) after applying
  15-bin sliding window. Right: first derivative histogram
  ($H_{DS}$) in black, and its respective smoothing in red
  ($H_{SDS}$). Here, the green vertical line shows the maximum or
  the first approach of \qpkvem.}
\end{figure}

The \qpkvem value is obtained from charge calibration histograms
by fitting the muon hump. We have implemented an algorithm which
uses the first derivative to perform this fit. The propose of
the derivative is to get a first approach of the hump position,
and from this to fix the fitting range. This algorithm is
illustrated in figure \ref{figChargeDerivative}, and detailed
next:
\begin{enumerate}
  \item Smoothing the histogram using a 15-bin sliding window,
    $H_S$.
  \item Obtaining the first derivative from $H_S$, applying
    \begin{equation}
      \frac{f(x+1)-f(x-1)}{2h} \, ,
    \end{equation}
    and named as $H_{DS}$.
  \item Smoothing $H_{DS}$, by 15-bin sliding window, and
    getting $H_{SDS}$.
  \item Searching for the estimated \qpkvem, i.e. first bin for
    $H_{SDS}$ equal to zero, from right to left.
  \item Fixing the fitting range using n-bin leftward and n-bin
    rightward from the estimated \qpkvem.
\end{enumerate}
\clearpage 

\begin{figure}[!t]
  \label{figFitStabNbins}
  \centering
  \subfigure {
    \includegraphics[width=.5\textwidth]{../../plots/uubChRmsFitBinsLrSt863.pdf}
    \includegraphics[width=.5\textwidth]{../../plots/uubChRmsFitBinsLrSt863zoom.pdf}
  }
  \subfigure{
    \includegraphics[width=.5\textwidth]{../../plots/chargeFitPoly2863.pdf}
    \includegraphics[width=.5\textwidth]{../../plots/chargeFitResidualsPoly2863.pdf}
  }
  \caption{Top row, results for the stability of fitting the hump
  muon (RMS/$\left<Q^\mathrm{Peak}_\mathrm{VEM}\right>$) as
  function of the n-bin. After 30 bins the stability is reached.
  Bottom row, an example of applying the algorithm; here the
  vertical green line shows the hump VEM obtained from the first
  derivative (step 4.), and the vertical blue line shows the
  \qpkvem obtained as the maximum of the fitted second order
  polynomial.}
  \label{figFitStabNbins}
\end{figure}

The last step in the algorithm requires an extra procedure in
order to fixed the number of n-bin. To this, a set of histograms
have been fitted using different values for n, and then we check
for the stability of the fit, i.e. RMS$_\mathrm{n}$/$\left<
Q^\mathrm{Peak}_\mathrm{VEM,\,n} \right>$. For this procedure, an
extra condition was implemented in order to avoid fit the valley
of the histogram. The results of this procedure is presented in
figure \ref{figFitStabNbins}. There, the stability of the fit
is seen at and after 30-bin, and this last one is chosen as the
number of n-bin for the step 5 of the algorithm. In the bottom
row of the same figure, an example of applying this procedure is
presented. Section \ref{secQpkVsTime} contains the \qpkvem values
obtained by this method for 75 UUB stations and for the same
stations but in UB version, using the same algorithm.

\section{Sliding window algorithm for \qpkvem accuracy
calculation}
\label{secSlidWindowAlgo}
Once the \qpkvem values have been obtained, we procedure to check
its accuracy for the UUB version, and compare it with the one
for UB version.\\\\The calculation of the accuracy is based on
the selection of a time window in which the \qpkvem as a function
of time was stable; here seven days in a row (7-day-row). To
determine this period of time, the average of the \qpkvem per day
was plotted as function of time for each of the 75 stations, from
August to November, year 2021 for UUB, and year 2018 for UB. In
order to chose the respective 7-day-row, a first condition was
set in terms of the minimum of values per day needed in each day.
With this porpoise, the distribution of \qpkvem per day was
calculate and presented in figure \ref{figDistQpkPerDay}, from
which we have chosen 10 \qpkvem values per day as the
minimum.
\clearpage

\begin{figure}[!t]
  \label{figDistQpkPerDay}
  \centering
  \subfigure {
    \includegraphics[width=.8\textwidth]{../../plots2/qpkDistPerDayUbUub.pdf}
  }
  \caption{Distribution of \qpkvem per day for 75 stations, from
  August to November, with UUB (red, year 2021) and UB (blue,
  year 2018) electronics version. The black line represents the
  respective Gaussian fit.}
  \label{figDistQpkPerDay}
\end{figure}

The sliding window algorithm was applied to each
station, and each PMT, following next steps:
\begin{enumerate}
  \item The $\left< Q^{\mathrm{Peak}}_{\mathrm{VEM}}\right>$ per
    day as function of time is calculate from August to November.
  \item Starting from the first day of August, a
    [7-day-series]$_0$ is build.
  \item A check for continuity is applied, i.e. if each day has
    not more then 10 \qpkvem values, or the 7 days are not
    consecutive a new series is built, e.g. if series $i$ has a
    discontinuity in day 3 jumping to day 5, a new 7-day-series
    is calculated from day 5.
  \item If [7-day-series]$_i$ is consecutive, a linear fit is
    applied to the 7-day-series, and the respective slope and
    p-value are stored.
\end{enumerate}

Figure \ref{figLogPvalVsSlop} shows the distribution for the
p-values as function of the normalized slope by the average of
the \qpkvem for the 7 days, and obtained with the former method;
applied for 75 stations, all PMTs, UB and UUB version,
respectively. There, it is seen how the normalized slope is
closer to zero for UB than UUB, whereas for both version the
$\log_{10}($p-value$)$ distribution has a hot spot for values
bigger than $-4$. After these results, and taking into the account 
that the number of degree of freedom is 5 for all the
fits\footnote{Here, only fits with 5 DOF were used; different
ones were rejected.}, we chose all fits ([7-days-row]$_i$)
matching with: $\chi^2<10$ ($\log_{10}($p-value$)<-1.12$), and
normalized slope in $\mu\pm\sigma$ (x axis, figure
\ref{figLogPvalVsSlop}).\\The results after these cuts are
presented in figure \ref{figProjSlop}, where the distribution of
the normalized slope is presented for both UB and UUB. Using
these results, we can chose the best 7-day-row to perform the
accuracy calculation.
\clearpage

\begin{figure}[!t]
  \label{figLogPvalVsSlop}
  \centering
  \subfigure {
    \includegraphics[width=0.55\textwidth]{../../plots2/chi2VsSlopUb2.pdf}
    \includegraphics[width=0.55\textwidth]{../../plots2/chi2VsSlopUub2.pdf}
  }
  \caption{Distribution of p-value as function of the slope,
  normalized by the average of the \qpkvem for the 7 days,
  obtained after applied the sliding window method (see text for
  details), for 75 stations, all PMT, UB (left), and UUB (right)
  version. A hot spot for p-values bigger than $-4$ is observed
  for UB and UUB, whereas the normalized slope closer to zero for
  UB than UUB.}
  \label{figLogPvalVsSlop}
\end{figure}
\section{Accuracy calculation}

The accuracy calculation was perform following the next steps for
each station, for both UB and UUB version:
\begin{enumerate}
  \item The best 7-day-row is chosen per PMT as the one with the
    normalized slope closest to zero and
    $\log_{10}($p-value$)<-1.12$.
  \item If for a certain station, either UB or UUB, some PMT has
    not a 7-day-row in agreement with the previous requirements,
    this PMT is remove for the calculation from both UB and UUB.
  \item For each PMT, a singular normalized distribution of the
    respective \qpkvem values, into the respective 7-day-row, is
    built.
  \item A Gaussian function is fitted to the normalized
    distribution and then the accuracy is calculated as:
    $\sigma/\mu$, respectively.
\end{enumerate}
An example of the steps 3 and 4 of former method are illustrated
in figure \ref{figQpkNormalizedSt1224}.
\clearpage


\begin{figure}[!t]
  \label{figProjSlop}
  \centering
  \subfigure {
    \includegraphics[width=0.55\textwidth]{../../plots2/chi2VsSlopUbProjSlop2.pdf}
    \includegraphics[width=0.55\textwidth]{../../plots2/chi2VsSlopUubProjSlop2.pdf}
  }
  \caption{Distribution of normalized slopes fitted for
  [7-days-row]$_i$ matching: $\chi^2<10$
  ($\log_{10}($p-value$)>-1.12$), and normalized slope
  $\mu\pm\sigma$ (x axis, figure  \ref{figLogPvalVsSlop}). For UB
  case, the mean of the distribution is closer to zero than UUB
  case.}
  \label{figProjSlop}
\end{figure}

The results of the \qpkvem accuracy calculation are presented in
figure \ref{figAccuracyResults}, where the plot of the accuracy
per station is presented on the left, whereas the accuracy
distribution of showed on the right figure. There, it is possible
to see that the accuracy for UUB version is
$1.61\,\%\pm0.06\,\%$, and for UB is $1.36\,\%\pm0.06\,\%$, which
differ from the $2\,\%$ calculated for the engineering array and
presented in \cite{gap2002-046}. Figure \ref{figOutlier1223}
present an example of one station with an outlier accuracy.\\\\On
the other hand, in figure \ref{figDiffAcc} the difference between
the accuracy for UB minus the one for UUB is presented per
station, left plot, together its distribution, right plot. There,
it is seen that in effect the UUB accuracy is bigger than UB for
the majority of the stations, with a mean value of
$-0.252\,\%\pm0.052\,\%$. In figure \ref{figOutlier1224} an
outlier example ($<-1\,\%$) is presented.

\clearpage

\begin{figure}[!t]
  \label{figQpkNormalizedSt1224}
  \centering
  \subfigure {
    \includegraphics[width=0.55\textwidth]{../../plots2/qpkdDistUBSt1224.pdf}
    \includegraphics[width=0.55\textwidth]{../../plots2/qpkdDistUUBSt1224.pdf}
  }
  \subfigure {
    \includegraphics[width=0.55\textwidth]{../../plots2/qpkdNormDistUBSt1224.pdf}
    \includegraphics[width=0.55\textwidth]{../../plots2/qpkdNormDistUUBSt1224.pdf}
  }  
  \caption{Example of the method applied to calculate the
  accuracy of the \qpkvem, station 1224. Upper row, distribution
  of the \qpkvem values from the best 7-day-raw selected; left
  UB, right UUB. Lower row, former distribution normalized
  respect the average of the respective PMT. The red line
  represents the Gauss function fitted.}
  \label{figQpkNormalizedSt1224}
\end{figure}

\begin{figure}[!t]
  \label{figAccuracyResults}
  \centering
  \subfigure {
    \includegraphics[width=.55\textwidth]{../../plots2/accQpkFitUbUubPerSt_Stats2.pdf}
    \includegraphics[width=.55\textwidth]{../../plots2/accQpkFitUbUubAllStAllPmt_Stats2.pdf}
  }
  \caption{Results for the accuracy calculation of the \qpkvem
  fitting, using the algorithm describe in section 
  \ref{secSlidWindowAlgo}; in blue color for UB, and in red color
  for UUB. In the right side, the distribution of the
  $\sigma/\mu$ values is presented for both version, UUB (red)
  and UB (blue). Here, it is possible to see that the accuracy
  for UUB is better than the one for UB.}
  \label{figAccuracyResults}
\end{figure}
\textcolor{white}{hi}
\clearpage

\begin{figure}
  \label{figDiffAcc}
  \centering
  \subfigure {
    \includegraphics[width=0.55\textwidth]{../../plots2/accQpkFitUbUubDiffPerSt_Stats2.pdf}
    \includegraphics[width=0.55\textwidth]{../../plots2/accQpkFitUbUubDistDiff_Stats2.pdf}
  }
  \caption{Difference between the accuracy for UB minus the one
  for UUB. Left, the plot of this difference per station. Right,
  its distribution. Here, it is possible to see how per UB
  stations the accuracy is lower than the one for the respective
  UUB version.}
  \label{figDiffAcc}
\end{figure}

\begin{figure}[!t]
  \label{figOutlier1223}
  \centering
  \subfigure {
    \includegraphics[width=0.55\textwidth]{../../plots2/qpkdDistUBSt1223.pdf}
    \includegraphics[width=0.55\textwidth]{../../plots2/qpkdDistUUBSt1223.pdf}
  }
  \subfigure {
    \includegraphics[width=0.55\textwidth]{../../plots2/qpkdNormDistUBSt1223.pdf}
    \includegraphics[width=0.55\textwidth]{../../plots2/qpkdNormDistUUBSt1223.pdf}
  }  
  \caption{Station 1223 with an outlier accuracy ($>10\,\%$).
  Here, it is possible to see how the PMT3 produce a wide
  distribution for the normalized \qpkvem.}
  \label{figOutlier1223}
\end{figure}

\textcolor{white}{hi}
\clearpage

\begin{figure}[!t]
  \label{figOutlier1224}
  \centering
  \subfigure {
    \includegraphics[width=0.55\textwidth]{../../plots2/qpkdDistUBSt1224.pdf}
    \includegraphics[width=0.55\textwidth]{../../plots2/qpkdDistUUBSt1224.pdf}
  }
  \subfigure {
    \includegraphics[width=0.55\textwidth]{../../plots2/qpkdNormDistUBSt1224.pdf}
    \includegraphics[width=0.55\textwidth]{../../plots2/qpkdNormDistUUBSt1224.pdf}
  }  
  \caption{Station 1224 with an outlier value for the difference
  between accuracy UB minus accuracy UUB ($<-1\,\%$). Here, it is
  seen that the normalized distribution of the \qpkvem values is
  wider in the UUB version than in UB one.}
  \label{figOutlier1224}
\end{figure}

\textcolor{white}{hi}
\clearpage

\section{Summary and conclusions}
We have presented a different method to fit the charge
calibration histograms and get the respective \qpkvem value. This
method used the first derivative of the histogram to estimate the
fitting range.\\\\
A sliding window method has been implemented to find the most
stable period for the \qpkvem, in both UB and UUB. In our case,
this period consist in seven days in a row.\\\\
We have calculate the accuracy of the \qpkvem using the
normalized distribution of the \qpkvem values inside the chosen
stable period. From there, we have calculated the accuracy for
the UUB version in $1.61\,\%\pm0.06\,\%$, and
$1.36\,\%\pm0.06\,\%$ for UB, which differ from the $2\,\%$
calculated in \cite{gap2002-046} for the engineering array.


\begin{thebibliography}{}
  \setlength{\itemsep}{0.0pt}
    \bibitem{augerPrimeDesign}
      A.~Aab \textit{et al.}, ``The Pierre Auger Observatory
      Upgrade - Preliminary Design Report,'' arXiv:1604.03637
      [astro-ph.IM].
    \bibitem{gap2003-030} M. Ave, P. Bauleo, T. Yamamoto,
      {\em Signal Fluctuation in the Auger Surface Detector
      Array}, GAP 2003-030
    \bibitem{gap2002-046} A. Tripathi, K. Arisaka, M. Healy, D.
      Barnhill, W. Slater, {\em A Systematic Calibration of
      Surface Detectors using Muon Data from the Engineering
      Array}, GAP 2002-046

\end{thebibliography}

\end{document}
